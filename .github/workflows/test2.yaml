name: Build for macOS 10.12

on: [push]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download macOS 10.12 SDK
      run: |
        curl -LJO https://github.com/phracker/MacOSX-SDKs/releases/download/10.13/MacOSX10.12.sdk.tar.xz
        mkdir -p $(xcode-select -p)/SDKs
        tar -xJf MacOSX10.12.sdk.tar.xz -C $(xcode-select -p)/SDKs

    - name: Set environment variables
      run: |
        echo "SDKROOT=$(xcode-select -p)/SDKs/MacOSX10.12.sdk" >> $GITHUB_ENV
        echo "CFLAGS=-isysroot ${SDKROOT} -mmacosx-version-min=10.12" >> $GITHUB_ENV
        echo "CXXFLAGS=-isysroot ${SDKROOT} -mmacosx-version-min=10.12" >> $GITHUB_ENV
        echo "LDFLAGS=-Wl,-syslibroot,${SDKROOT}" >> $GITHUB_ENV

    - name: CMake configure
      run: cmake . -Bbuild -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_DEPLOYMENT_TARGET=10.12 -DTHREADS_PTHREAD_ARG=ON
        
    - name: Build
      run: make -Cbuild -j$(sysctl -n hw.ncpu) steam_api
        
    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
          tag_name: latest
          files: |
            build/libsteam_api.dylib
            build/lobby_connect
            build/generate_interfaces_file
